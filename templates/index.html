<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Shazomi Demo</title>
    <style>
      body { font-family: sans-serif; padding: 20px; }
      .row { margin-bottom: 12px }
    </style>
  </head>
  <body>
    <h1>Shazomi Fingerprinting Demo</h1>

    <div class="row">
      <label>Upload audio file (mp3/wav):</label>
      <input id="file" type="file" accept="audio/*" />
      <button id="upload">Upload & Process</button>
    </div>

    <div class="row">
      <label>Or record from your mic:</label>
      <button id="record">Start Recording (5s)</button>
    </div>

    <div id="result"></div>

    <script>
      async function postFile(file) {
        const fd = new FormData();
        fd.append('file', file, file.name || 'recording.webm');

        const res = await fetch('/process', { method: 'POST', body: fd });
        return res.json();
      }

      document.getElementById('upload').onclick = async () => {
        const inp = document.getElementById('file');
        if (!inp.files.length) return alert('pick a file');
        const out = await postFile(inp.files[0]);
        showResult(out);
      };

      document.getElementById('record').onclick = async () => {
        const btn = document.getElementById('record');
        btn.disabled = true;
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const rec = new MediaRecorder(stream);
        const chunks = [];
        rec.ondataavailable = e => chunks.push(e.data);
        rec.start();
        setTimeout(() => rec.stop(), 5000);
        const p = new Promise(resolve => rec.onstop = resolve);
        await p;
        const blob = new Blob(chunks, { type: 'audio/webm' });
        const file = new File([blob], 'recording.webm', { type: 'audio/webm' });
        const out = await postFile(file);
        showResult(out);
        stream.getTracks().forEach(t => t.stop());
        btn.disabled = false;
      };

      function showResult(out) {
        const d = document.getElementById('result');
        if (out.error) return d.innerText = out.error;
        d.innerHTML = `Hashes: ${out.hashes}<br/>Peaks: ${out.peaks}<br/><img src="${out.spectrogram}" style="max-width:90%"/>`;
      }
    </script>
  </body>
</html>
